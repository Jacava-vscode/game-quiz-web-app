# User collection schema (MongoDB Atlas / Mongoose)

This document describes the `users` collection schema used by the Game Quiz backend.

MongoDB Collection: `users`

Mongoose model: `backend/src/models/User.js`

## Fields

- _id (ObjectId) - automatically generated by MongoDB
- id (string) - virtual field exposing `_id` as hex string (for API responses)
- username (string, required, unique) - trimmed, min length 3
- email (string, required, unique) - stored lowercase and trimmed
- passwordHash (string, required) - bcrypt hash (do not expose)
- displayName (string, optional) - public display name
- bio (string, optional) - short user bio
- avatarUrl (string, optional) - URL to avatar image
- score (number, default 0) - aggregate user score
- roles (array[string], default ['player']) - e.g., ['player','admin']
- achievements (array[string]) - simple achievement identifiers
- completedQuizzes (array[object]) - embedded documents with quizId, score, category, difficulty, completedAt
- lastLoginAt (date, optional)
- createdAt, updatedAt (timestamps) - managed by Mongoose

## Indexes

- `{ email: 1 }` unique
- `{ username: 1 }` unique

Create these indexes in Atlas or rely on Mongoose schema indexes.

## Recommended MongoDB Atlas Schema Validation (JSON Schema)

You can add a JSON Schema validator to your Atlas collection to enforce basic structure.

Example validator (relatively permissive):

```
{
  "$jsonSchema": {
    "bsonType": "object",
    "required": ["username", "email", "passwordHash"],
    "properties": {
      "username": { "bsonType": "string", "minLength": 3 },
      "email": { "bsonType": "string" },
      "passwordHash": { "bsonType": "string" },
      "displayName": { "bsonType": "string" },
      "bio": { "bsonType": "string" },
      "avatarUrl": { "bsonType": "string" },
      "score": { "bsonType": "int" },
      "roles": { "bsonType": "array" },
      "achievements": { "bsonType": "array" },
      "completedQuizzes": { "bsonType": "array" }
    }
  }
}
```

Apply this in the Atlas UI under Collections â†’ Validation (or use the Atlas API).

## Security & Operational notes

- Never store raw passwords. Use bcrypt/bcryptjs to hash before saving.
- Do not return `passwordHash` in API responses. The Mongoose model strips it by default via `toJSON` transform.
- Consider adding rate limiting and email verification flows for production.
- If you need TTL for inactive accounts, consider a `deletedAt` field and a background job to purge.

## Example document

```
{
  "_id": ObjectId("...")
  "username": "player1",
  "email": "player1@example.com",
  "passwordHash": "$2a$10$...",
  "displayName": "Player One",
  "avatarUrl": "https://.../avatar.png",
  "score": 120,
  "roles": ["player"],
  "achievements": ["first_win"],
  "completedQuizzes": [ { "quizId": ObjectId("..."), "score": 8, "category": "history", "difficulty": "easy", "completedAt": ISODate("...") } ],
  "createdAt": ISODate("..."),
  "updatedAt": ISODate("...")
}
```
